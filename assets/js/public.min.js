(function ($) {
  "use strict";

  var coverflowSluide = function () {
    var $slider = $(".wpt-coverflow");

    var autoplay = $slider.data("autoplay");
    var loop = $slider.data("loop");

    var swiper = new Swiper(".wpt-coverflow", {
      effect: "coverflow",
      grabCursor: true,
      centeredSlides: true,
      slidesPerView: "auto",
      loop: loop,
      autoplay: {
        delay: autoplay,
        disableOnInteraction: false,
        pauseOnMouseEnter: true,
      },
      coverflowEffect: {
        rotate: 50,
        stretch: 0,
        depth: 100,
        modifier: 1,
        slideShadows: false,
      },
      navigation: {
        nextEl: ".swiper-button-next",
        prevEl: ".swiper-button-prev",
      },
    });
  };

  var wptaccordion = function () {
    // Open the first item by default
    $(".wpt-accordion-header:first").addClass("active");
    $(".wpt-accordion-content:first").show();
    $(".wpt-accordion-header:first .wpt-accordion-toggle").text("-");

    $(".wpt-accordion-header").click(function () {
      // Close all other items
      $(".wpt-accordion-header").not(this).removeClass("active");
      $(".wpt-accordion-content").not($(this).next()).hide();
      $(".wpt-accordion-header .wpt-accordion-toggle").not(this).text("+");

      // Toggle the clicked item
      $(this).toggleClass("active");
      $(this).next(".wpt-accordion-content").show();

      // Update the toggle icon
      const toggleIcon = $(this).find(".wpt-accordion-toggle");
      if ($(this).hasClass("active")) {
        toggleIcon.text("-");
      } else {
        toggleIcon.text("+");
      }
    });
  };

  // When a speaker item is clicked, load details via AJAX.
  var speakergridpopup = function () {
    $(".speaker-grid").on("click", ".speaker-item", function () {
      var speaker_id = $(this).data("speaker-id");
      $.ajax({
        url: speakerGrid.ajax_url,
        type: "POST",
        data: {
          action: "load_speaker_details",
          speaker_id: speaker_id,
        },
        success: function (response) {
          if (response.success) {
            $("#speaker-details").html(response.data);
            $("#speaker-popup").fadeIn();
          } else {
            alert("Error: " + response.data);
          }
        },
      });
    });

    // Close the popup.
    $("#speaker-popup").on("click", ".close-popup", function () {
      $("#speaker-popup").fadeOut();
    });

    // Close popup when clicking outside the popup content area
    $("#speaker-popup").on("click", function (e) {
      if (!$(e.target).closest(".speaker-popup-content").length) {
        $("#speaker-popup").fadeOut();
      }
    });
  };

  // Package Tab
  var packageTab = function () {
    $(".wpt-package-wrap").each(function () {
      var $wptContainer = $(this);
      var packageType = $wptContainer.data("package-type");
      var wptInstanceID = $wptContainer.data("wpt-instance-id");

      // Load package tabs via AJAX for this widget instance
      $.ajax({
        url: packageTabObj.ajax_url,
        method: "POST",
        data: {
          action: "load_package_tabs",
          package_type: packageType,
          wpt_instance_id: wptInstanceID,
        },
        success: function (response) {
          if (response.success) {
            $wptContainer.find(".wpt-package-tabs").html(response.data.tabs);
            $wptContainer
              .find(".wpt-package-content")
              .html(response.data.content);
            // Show the first package detail by default
            $wptContainer.find(".wpt-package-content-item").hide();
            $wptContainer.find(".wpt-package-content-item").first().show();
            $wptContainer.find(".wpt-tab-item").first().addClass("active");
          }
        },
      });

      // Bind click event within this widget instance
      $wptContainer.on("click", ".wpt-tab-item", function () {
        var packageID = $(this).data("package");

        $wptContainer.find(".wpt-tab-item").removeClass("active");
        $(this).addClass("active");

        $wptContainer.find(".wpt-package-content-item").hide();
        $wptContainer.find("#package-" + packageID).show();

        // Scroll down to the content item smoothly
        $("html, body").animate(
          {
            scrollTop: $wptContainer.find("#package-" + packageID).offset().top,
          },
          500
        );
      });
    });
  };

  function bindPlayIcon() {
    $(".video-play-icon")
      .off("click")
      .on("click", function (e) {
        e.preventDefault();
        var videoUrl = $(this).data("video-url");
        // Convert standard YouTube links to embed format if necessary.
        if (videoUrl.indexOf("youtube.com/watch") > -1) {
          videoUrl = videoUrl.replace("watch?v=", "embed/");
        }
        var iframe =
          '<iframe src="' +
          videoUrl +
          '" frameborder="0" allowfullscreen style="position:absolute; top:0; left:0; width:100%; height:100%;"></iframe>';
        $("#video-popup .video-popup-inner").html(iframe);
        $("#video-popup").fadeIn();
      });
  }

  // Bind the play icon on document ready.
  $(document).ready(function () {
    bindPlayIcon();

    // Close the popup when clicking on the close button or the overlay.
    $("#video-popup, .video-popup-close").on("click", function (e) {
      e.preventDefault();
      $("#video-popup").fadeOut(function () {
        $("#video-popup .video-popup-inner").html("");
      });
    });

    // Prevent clicks on the popup content from closing the popup.
    $(".video-popup-content").on("click", function (e) {
      e.stopPropagation();
    });
  });

  $(window).on("elementor/frontend/init", function () {
    elementorFrontend.hooks.addAction(
      "frontend/element_ready/wpt-coverflow-slider-id.default",
      coverflowSluide
    );
  });

  $(window).on("elementor/frontend/init", function () {
    elementorFrontend.hooks.addAction(
      "frontend/element_ready/wpt-accordion-id.default",
      wptaccordion
    );
  });

  $(window).on("elementor/frontend/init", function () {
    elementorFrontend.hooks.addAction(
      "frontend/element_ready/wpt-team-card-id.default",
      speakergridpopup
    );
  });

  $(window).on("elementor/frontend/init", function () {
    elementorFrontend.hooks.addAction(
      "frontend/element_ready/wpt-package-tab-id.default",
      packageTab
    );
  });
})(jQuery);
